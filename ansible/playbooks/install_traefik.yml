---
- name: Instalar y Configurar Traefik como Ingress Controller usando Docker
  hosts: load_balancers
  become: true

  vars:
    traefik_config_dir: "/etc/traefik"
    traefik_token_path: "/mnt/traefik-token/traefik.jwt"
    nfs_backup_token_path: "/srv/nfs/traefik-token/traefik.jwt"
    kubeconfig_path: "/etc/traefik/traefik-kubeconfig.yaml"
    k8s_api_vip: "10.17.5.10"
    master1_ip: "10.17.4.21"
    storage_ip: "10.17.4.27"

  tasks:
    - name: ğŸ“„ Copiar certificado CA del API server desde master1
      delegate_to: "{{ master1_ip }}"
      run_once: true
      raw: cat /var/lib/rancher/k3s/server/tls/server-ca.crt
      register: server_ca_cert
      changed_when: false

    - name: ğŸ“ Crear directorios para Traefik
      raw: mkdir -p /etc/traefik /etc/traefik/certs /etc/traefik/dynamic_conf
      changed_when: false

    - name: ğŸ“ Crear directorio local para montar NFS (modo raw por compatibilidad)
      raw: mkdir -p /mnt/traefik-token
      changed_when: false

    - name: ğŸ”´ Crear carpeta y exportaciÃ³n NFS en storage1
      delegate_to: "{{ storage_ip }}"
      become: true
      block:
        - name: Crear carpeta /srv/nfs/traefik-token
          raw: mkdir -p /srv/nfs/traefik-token && chmod 0777 /srv/nfs/traefik-token

        - name: Asegurar entrada en /etc/exports
          raw: |
            grep -q "/srv/nfs/traefik-token" /etc/exports || echo "/srv/nfs/traefik-token 10.17.3.0/24(rw,sync,no_subtree_check,no_root_squash)" >> /etc/exports

        - name: Aplicar exportfs y reiniciar nfs-server
          raw: |
            exportfs -rav
            systemctl restart nfs-server

    - name: ğŸ”— Montar NFS con token traefik.jwt desde storage1
      shell: |
        mkdir -p /mnt/traefik-token
        mountpoint -q /mnt/traefik-token || mount -t nfs {{ storage_ip }}:/srv/nfs/traefik-token /mnt/traefik-token
      args:
        executable: /bin/bash
      register: mount_result
      failed_when: mount_result.rc != 0 and 'access denied' not in mount_result.stderr

    - name: ğŸ“… Guardar server-ca.crt en los balanceadores
      copy:
        content: "{{ server_ca_cert.stdout_lines | join('\n') }}"
        dest: "{{ traefik_config_dir }}/certs/server-ca.crt"
        mode: "0644"

    - name: ğŸ§¹ Eliminar ServiceAccount y ClusterRoleBinding previos
      delegate_to: "{{ master1_ip }}"
      run_once: true
      raw: |
        kubectl delete clusterrolebinding traefik-sa-crb --ignore-not-found=true || true
        kubectl delete sa traefik-sa -n default --ignore-not-found=true || true

    - name: ğŸ›¡ Crear ServiceAccount para Traefik
      delegate_to: "{{ master1_ip }}"
      run_once: true
      raw: kubectl create sa traefik-sa --namespace default || true

    - name: ğŸ” Crear ClusterRoleBinding para traefik-sa
      delegate_to: "{{ master1_ip }}"
      run_once: true
      raw: kubectl create clusterrolebinding traefik-sa-crb --clusterrole=cluster-admin --serviceaccount=default:traefik-sa

    - name: ğŸ“Ÿ Generar token JWT para traefik-sa
      delegate_to: "{{ master1_ip }}"
      run_once: true
      raw: kubectl -n default create token traefik-sa
      register: sa_token_jwt
      changed_when: false

    - name: ğŸ’¾ Guardar token JWT en /mnt/traefik-token
      shell: |
        echo '{{ sa_token_jwt.stdout | default('''') | trim }}' > {{ traefik_token_path }} && chmod 0600 {{ traefik_token_path }}
      args:
        executable: /bin/bash

    - name: ğŸ’¾ Guardar copia del token JWT en storage1
      delegate_to: "{{ storage_ip }}"
      become: true
      shell: echo '{{ sa_token_jwt.stdout | default('''') | trim }}' > {{ nfs_backup_token_path }} && chmod 0600 {{ nfs_backup_token_path }}
      args:
        executable: /bin/bash

    - name: âš™ï¸ Generar kubeconfig para Traefik
      delegate_to: "{{ master1_ip }}"
      run_once: true
      raw: |
        kubectl config set-cluster k3s-cluster \
          --server=https://{{ k8s_api_vip }}:6443 \
          --certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt \
          --embed-certs=true \
          --kubeconfig={{ kubeconfig_path }}

        kubectl config set-credentials traefik-sa \
          --token={{ sa_token_jwt.stdout | default('''') | trim }} \
          --kubeconfig={{ kubeconfig_path }}

        kubectl config set-context traefik-context \
          --cluster=k3s-cluster \
          --user=traefik-sa \
          --kubeconfig={{ kubeconfig_path }}

        kubectl config use-context traefik-context \
          --kubeconfig={{ kubeconfig_path }}

    - name: ğŸ”§ Generar traefik.toml
      template:
        src: "{{ playbook_dir }}/templates/traefik/traefik.toml.j2"
        dest: "{{ traefik_config_dir }}/traefik.toml"
        mode: "0644"
      vars:
        vip: "{{ k8s_api_vip }}"

    - name: ğŸ³ Generar archivo docker-compose.yml
      template:
        src: "{{ playbook_dir }}/templates/traefik/docker-compose.yml.j2"
        dest: "{{ traefik_config_dir }}/docker-compose.yml"
        mode: "0644"
      vars:
        vip: "{{ k8s_api_vip }}"

    - name: ğŸ”„ Reiniciar contenedor Traefik con nuevo token
      shell: |
        docker compose -f {{ traefik_config_dir }}/docker-compose.yml down || true
        docker compose -f {{ traefik_config_dir }}/docker-compose.yml up -d
      args:
        executable: /bin/bash

    - name: âœ… Verificar estado del contenedor Traefik
      shell: docker ps -a | grep traefik || true
      register: traefik_status

    - name: ğŸ“Š Mostrar estado del contenedor Traefik
      debug:
        msg: "{{ traefik_status.stdout_lines }}"