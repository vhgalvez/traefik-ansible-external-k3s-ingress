# ansible\playbooks\install_traefik.yml
---
- name: Instalar y Configurar Traefik como Ingress Controller usando Docker
  hosts: load_balancers
  become: true

  vars:
    traefik_config_dir: "/etc/traefik"
    traefik_token_path: "/mnt/traefik-token/traefik.jwt"
    nfs_backup_token_path: "/srv/nfs/traefik-token/traefik.jwt"
    kubeconfig_path: "/etc/traefik/traefik-kubeconfig.yaml"
    k8s_api_vip: "10.17.5.10"
    master1_ip: "10.17.4.21"
    storage_ip: "10.17.4.27"

  tasks:
    - name: 📄 Copiar certificado CA del API server desde master1
      delegate_to: "{{ master1_ip }}"
      run_once: true
      raw: cat /var/lib/rancher/k3s/server/tls/server-ca.crt
      register: server_ca_cert
      changed_when: false

    - name: 📁 Crear directorios para Traefik
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "/etc/traefik"
        - "/etc/traefik/certs"
        - "/etc/traefik/dynamic_conf"

    - name: 🔒 Verificar si existe el certificado autofirmado
      stat:
        path: "{{ traefik_config_dir }}/certs/traefik.crt"
      register: cert_stat

    - name: 🔑 Verificar si existe la clave privada autofirmada
      stat:
        path: "{{ traefik_config_dir }}/certs/traefik.key"
      register: key_stat

    - name: 🔧 Generar certificado autofirmado traefik.crt y traefik.key si no existen
      shell: |
        openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
          -subj "/CN=traefik.local" \
          -keyout {{ traefik_config_dir }}/certs/traefik.key \
          -out {{ traefik_config_dir }}/certs/traefik.crt
      args:
        executable: /bin/bash
      when: not cert_stat.stat.exists or not key_stat.stat.exists

    - name: 📁 Establecer permisos seguros para los certificados
      file:
        path: "{{ item.path }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: "{{ traefik_config_dir }}/certs/traefik.crt", mode: "0644" }
        - { path: "{{ traefik_config_dir }}/certs/traefik.key", mode: "0600" }

    - name: 🧱 Instalar unidad systemd para traefik-docker
      template:
        src: "{{ playbook_dir }}/templates/traefik/traefik-docker.service.j2"
        dest: "/etc/systemd/system/traefik-docker.service"
        mode: "0644"

    - name: 💠 Recargar daemon de systemd
      command: systemctl daemon-reexec

    - name: ⚙️ Habilitar traefik-docker para reinicio automático
      systemd:
        name: traefik-docker.service
        enabled: true
        daemon_reload: true

    - name: 🔃 Iniciar servicio Traefik
      systemd:
        name: traefik-docker.service
        state: restarted
        enabled: true

    - name: ✅ Verificar estado del contenedor Traefik
      shell: docker ps -a | grep traefik || true
      register: traefik_status

    - name: 📊 Mostrar estado del contenedor Traefik
      debug:
        msg: "{{ traefik_status.stdout_lines }}"