# ansible/playbooks/install_traefik.yml
---
- name: Instalar y Configurar Traefik como Ingress Controller usando Docker
  hosts: load_balancers
  become: true

  vars:
    traefik_config_dir: "/etc/traefik"
    kubeconfig_path: "/etc/traefik/traefik-kubeconfig.yaml"
    kubeconfig_backup_path: "/srv/nfs/traefik-token/traefik-kubeconfig.yaml"
    k8s_api_vip: "10.17.5.10"
    master1_ip: "10.17.4.21"
    storage_ip: "10.17.4.27"

  tasks:
    # Verificar si el kubeconfig_path existe como directorio y eliminarlo
    - name: ‚ùå Eliminar kubeconfig si es un directorio
      file:
        path: "{{ kubeconfig_path }}"
        state: absent
      when: kubeconfig_path | basename == 'traefik-kubeconfig.yaml'
      ignore_errors: true

    # Verificar si el archivo kubeconfig existe en master1
    - name: üîç Verificar si kubeconfig existe en master1
      delegate_to: "{{ master1_ip }}"
      run_once: true
      raw: test -f /etc/traefik/traefik-kubeconfig.yaml
      register: kubeconfig_exists
      ignore_errors: true

    - name: ‚ùå Abortamos si el archivo kubeconfig no existe en master1
      fail:
        msg: "El archivo kubeconfig no se encontr√≥ en master1. Verifica la creaci√≥n del archivo."
      when: kubeconfig_exists.rc != 0

    # Generar el kubeconfig en master1 si no existe
    - name: Generar kubeconfig en master1
      delegate_to: "{{ master1_ip }}"
      run_once: true
      command: |
        sudo cp /etc/rancher/k3s/k3s.yaml /etc/traefik/traefik-kubeconfig.yaml
      when: kubeconfig_exists.rc != 0

    # Reemplazar la URL en kubeconfig para que apunte a la IP VIP
    - name: Reemplazar la IP en kubeconfig para apuntar a la IP VIP
      lineinfile:
        path: "{{ kubeconfig_path }}"
        regexp: 'server: https://127.0.0.1:6443'
        line: "server: https://{{ k8s_api_vip }}:6443"
      become: true

    # Copiar certificado CA del API server desde master1
    - name: üìÑ Copiar certificado CA del API server desde master1
      delegate_to: "{{ master1_ip }}"
      run_once: true
      raw: cat /var/lib/rancher/k3s/server/tls/server-ca.crt
      register: server_ca_cert
      changed_when: false

    # Crear directorios para Traefik
    - name: üìÅ Crear directorios para Traefik
      file:
        path: "{{ traefik_config_dir }}/certs"
        state: directory
        mode: "0755"
      changed_when: false

    # Crear directorio para kubeconfig si no existe
    - name: üìÅ Crear directorio para kubeconfig si no existe
      file:
        path: "{{ traefik_config_dir }}"
        state: directory
        mode: "0755"

    # Verificar permisos del directorio de destino
    - name: Verificar permisos de /etc/traefik
      command: ls -ld /etc/traefik
      register: dir_permissions
      ignore_errors: true

    - name: Establecer permisos de escritura en /etc/traefik
      command: chmod 755 /etc/traefik
      when: dir_permissions.rc != 0

    # Fetch kubeconfig from master1 to Ansible controller
    - name: üóÇ Fetch kubeconfig from master1 to Ansible controller
      fetch:
        src: "{{ kubeconfig_path }}"
        dest: "/tmp/traefik-kubeconfig.yaml"
        flat: yes
      delegate_to: "{{ master1_ip }}"
      run_once: true
      become: false  # Ensure we fetch as the core user

    # Copiar kubeconfig a cada load balancer
    - name: üì§ Copiar kubeconfig a cada load balancer
      copy:
        src: "/tmp/traefik-kubeconfig.yaml"
        dest: "{{ kubeconfig_path }}"
        owner: root
        group: root
        mode: "0600"
      become: true  # Ensure root permissions on load balancer
      loop: "{{ groups['load_balancers'] }}"
      loop_control:
        loop_var: inventory_hostname

    - name: üßπ Limpiar archivo temporal de kubeconfig
      file:
        path: "/tmp/traefik-kubeconfig.yaml"
        state: absent
      delegate_to: localhost
      run_once: true

    # Restante de configuraci√≥n de Traefik
    - name: üîß Generar traefik.toml
      template:
        src: "{{ playbook_dir }}/templates/traefik/traefik.toml.j2"
        dest: "{{ traefik_config_dir }}/traefik.toml"
        mode: "0644"
      vars:
        vip: "{{ k8s_api_vip }}"

    - name: üöì Generar archivo docker-compose.yml
      template:
        src: "{{ playbook_dir }}/templates/traefik/docker-compose.yml.j2"
        dest: "{{ traefik_config_dir }}/docker-compose.yml"
        mode: "0644"
      vars:
        vip: "{{ k8s_api_vip }}"

    - name: Eliminar acme.json si es un directorio por error
      file:
        path: "{{ traefik_config_dir }}/acme.json"
        state: absent
        force: true

    - name: Crear archivo acme.json correctamente
      copy:
        dest: "{{ traefik_config_dir }}/acme.json"
        content: "{}"
        mode: "0600"

    - name: ü§© Eliminar contenedor traefik si ya existe (evitar conflicto de nombres)
      shell: docker rm -f traefik || true
      args:
        executable: /bin/bash

    - name: ‚Ü∫ Reiniciar contenedor Traefik con nuevo kubeconfig
      shell: docker compose -f {{ traefik_config_dir }}/docker-compose.yml up -d
      args:
        executable: /bin/bash

    - name: ‚úÖ Verificar estado del contenedor Traefik
      shell: docker ps -a | grep traefik || true
      register: traefik_status

    - name: üìä Mostrar estado del contenedor Traefik
      debug:
        msg: "{{ traefik_status.stdout_lines }}"

    - name: üñº Copiar unidad systemd traefik-docker.service
      template:
        src: "{{ playbook_dir }}/templates/traefik/traefik-docker.service.j2"
        dest: "/etc/systemd/system/traefik-docker.service"
        mode: "0644"

    - name: üîÅ Recargar systemd
      command: systemctl daemon-reload

    - name: ‚úÖ Habilitar traefik-docker.service
      systemd:
        name: traefik-docker.service
        enabled: true

    - name: ‚ñ∂Ô∏è Iniciar traefik-docker.service
      systemd:
        name: traefik-docker.service
        state: started