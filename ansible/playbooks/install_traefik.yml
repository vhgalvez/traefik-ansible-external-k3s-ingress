---
- name: 🚀 Instalar y Configurar Traefik como Ingress Controller usando Docker
  hosts: load_balancers
  become: true

  vars:
    traefik_config_dir: "/etc/traefik"
    traefik_token_path: "/etc/traefik/token"
    traefik_env_path: "/etc/traefik/.env"
    k8s_api_vip: "10.17.5.10"
    master1_ip: "10.17.4.21"

  tasks:
    - name: 🐍 Instalar Python 3 y pip en AlmaLinux
      package:
        name:
          - python3
          - python3-pip
        state: present

    - name: 🔥 Eliminar Podman y herramientas relacionadas
      package:
        name:
          - podman
          - podman-docker
          - buildah
        state: absent
      ignore_errors: true

    - name: 🧹 Eliminar carpetas de contenedores si existen
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /var/lib/containers
        - /etc/containers
      ignore_errors: true

    - name: 🐳 Instalar Docker CE y plugin docker compose
      package:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present

    - name: ▶️ Habilitar y arrancar Docker
      systemd:
        name: docker
        enabled: true
        state: started

    - name: 📁 Crear directorios para Traefik
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ traefik_config_dir }}"
        - "{{ traefik_config_dir }}/certs"
        - "{{ traefik_config_dir }}/dynamic_conf"

    - name: 📄 Copiar certificados TLS
      copy:
        src: "files/certs/traefik.local.{{ item }}"
        dest: "{{ traefik_config_dir }}/certs/traefik.local.{{ item }}"
        mode: "0644"
      loop:
        - crt
        - key

    - name: 🧹 Eliminar traefik.toml si es un directorio por error
      file:
        path: "{{ traefik_config_dir }}/traefik.toml"
        state: absent
        force: true

    - name: 📄 Crear archivo acme.json
      copy:
        dest: "{{ traefik_config_dir }}/acme.json"
        content: "{}"
        mode: "0600"

    - name: 📥 Copiar kubeconfig desde master1 a localhost
      delegate_to: localhost
      become: false
      run_once: true
      shell: |
        scp -o StrictHostKeyChecking=no -i /root/.ssh/id_rsa core@{{ master1_ip }}:/etc/rancher/k3s/k3s.yaml /tmp/kubeconfig-traefik
      register: kubeconfig_copied

    - name: 🔐 Crear ServiceAccount y ClusterRoleBinding + Obtener token
      delegate_to: localhost
      become: false
      run_once: true
      block:
        - name: 🛡️ Crear ServiceAccount para Traefik
          shell: |
            KUBECONFIG=/tmp/kubeconfig-traefik kubectl -n kube-system create serviceaccount traefik-ingress-controller --dry-run=client -o yaml | kubectl apply -f -

        - name: 🔐 Crear ClusterRoleBinding para Traefik
          shell: |
            KUBECONFIG=/tmp/kubeconfig-traefik kubectl create clusterrolebinding traefik-ingress-controller \
              --clusterrole=cluster-admin \
              --serviceaccount=kube-system:traefik-ingress-controller \
              --dry-run=client -o yaml | kubectl apply -f -

        - name: 🔑 Obtener token del ServiceAccount
          shell: |
            TOKEN_NAME=$(KUBECONFIG=/tmp/kubeconfig-traefik kubectl -n kube-system get sa traefik-ingress-controller -o jsonpath='{.secrets[0].name}')
            KUBECONFIG=/tmp/kubeconfig-traefik kubectl -n kube-system get secret $TOKEN_NAME -o jsonpath='{.data.token}' | base64 -d
          register: sa_token

    - name: 🧽 Eliminar kubeconfig temporal
      delegate_to: localhost
      become: false
      run_once: true
      file:
        path: /tmp/kubeconfig-traefik
        state: absent

    - name: 📂 Guardar token en archivo en los nodos Traefik
      copy:
        content: "{{ sa_token.stdout }}"
        dest: "{{ traefik_token_path }}"
        mode: "0600"

    - name: ⚙️ Generar traefik.toml
      template:
        src: "../../templates/traefik/traefik.toml.j2"
        dest: "{{ traefik_config_dir }}/traefik.toml"
        mode: "0644"
      vars:
        traefik_token: "{{ sa_token.stdout }}"
        vip: "{{ k8s_api_vip }}"

    - name: ⚙️ Generar archivo .env
      template:
        src: "../../templates/traefik/env.j2"
        dest: "{{ traefik_env_path }}"
        mode: "0644"
      vars:
        vip: "{{ k8s_api_vip }}"
        traefik_dir: "{{ traefik_config_dir }}"
        traefik_token_path: "{{ traefik_token_path }}"

    - name: 🐳 Generar archivo docker-compose.yml
      template:
        src: "../../templates/traefik/docker-compose.yml.j2"
        dest: "{{ traefik_config_dir }}/docker-compose.yml"
        mode: "0644"

    - name: 🚀 Lanzar o reiniciar contenedor Traefik
      shell: |
        docker compose -f {{ traefik_config_dir }}/docker-compose.yml --env-file {{ traefik_env_path }} down || true
        docker compose -f {{ traefik_config_dir }}/docker-compose.yml --env-file {{ traefik_env_path }} up -d
      args:
        executable: /bin/bash

    - name: ✅ Verificar estado del contenedor Traefik
      shell: docker ps -a | grep traefik
      register: traefik_status

    - name: 📋 Mostrar estado del contenedor Traefik
      debug:
        msg: "{{ traefik_status.stdout_lines }}"