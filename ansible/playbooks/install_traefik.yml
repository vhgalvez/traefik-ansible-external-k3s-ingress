---
# 📦 Playbook maestro para actualizar configuración de máquinas externas (extraScrapeConfigs.yaml)

- name: 🔄 Actualizar objetivos externos de Prometheus
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    extra_scrape_config_path: "/tmp/prometheus_manifests/extraScrapeConfigs.yaml"

  tasks:
    - name: 📁 Crear carpeta para manifests si no existe
      file:
        path: "{{ extra_scrape_config_path | dirname }}"
        state: directory
        mode: '0755'

    - name: 🧩 Renderizar archivo extraScrapeConfigs.yaml
      template:
        src: "roles/prometheus/templates/extraScrapeConfigs.yaml.j2"
        dest: "{{ extra_scrape_config_path }}"

    - name: 🔐 Crear o actualizar Secret en Kubernetes
      command: >
        /usr/local/bin/kubectl create secret generic prometheus-additional-scrape-configs
        --from-file=extraScrapeConfigs.yaml={{ extra_scrape_config_path }}
        --namespace monitoring --dry-run=client -o yaml |
        /usr/local/bin/kubectl apply -f -
      environment:
        KUBECONFIG: "/home/victory/.kube/config"

    - name: ✅ Confirmación
      debug:
        msg: "✅ Archivo extraScrapeConfigs.yaml actualizado y Secret aplicado correctamente."

    - name: 📦 Asegurar que el servicio NFS esté habilitado
      become: true
      service:
        name: nfs-server
        state: started
        enabled: true
      when: ansible_facts['os_family'] == "RedHat"

    - name: 🛠️ Crear unidad systemd para Traefik con Docker Compose
      template:
        src: templates/traefik/traefik-docker.service.j2
        dest: /etc/systemd/system/traefik-docker.service
        mode: "0644"

    - name: 📦 Recargar systemd para aplicar cambios
      systemd:
        daemon_reload: yes

    - name: ✅ Habilitar y arrancar Traefik como servicio systemd
      systemd:
        name: traefik-docker.service
        enabled: true
        state: started