# ansible\playbooks\reset_traefik_env.yml
---
- name: ğŸ” Reset completo del entorno Traefik (token, NFS, contenedor)
  hosts: load_balancers
  become: true

  vars:
    traefik_config_dir: "/etc/traefik"
    traefik_token_path: "/mnt/traefik-token/traefik.jwt"
    nfs_backup_token_path: "/srv/nfs/traefik-token/traefik.jwt"
    storage_ip: "10.17.4.27"

  tasks:
    - name: âŒ Desmontar NFS si estÃ¡ montado
      shell: |
        mountpoint -q /mnt/traefik-token && umount -f /mnt/traefik-token || true
      args:
        executable: /bin/bash

    - name: ğŸ§¹ Eliminar token JWT local si existe
      file:
        path: "{{ traefik_token_path }}"
        state: absent

    - name: ğŸ§¹ Eliminar contenedor traefik si existe
      shell: docker rm -f traefik || true
      args:
        executable: /bin/bash

    - name: ğŸ§¹ Borrar volumen NFS remoto del token traefik.jwt (modo raw)
      delegate_to: "{{ storage_ip }}"
      raw: rm -f {{ nfs_backup_token_path }}

    - name: ğŸ§¹ Eliminar configuraciÃ³n traefik local si deseas (opcional)
      file:
        path: "{{ traefik_config_dir }}"
        state: absent
      when: traefik_config_dir is defined and traefik_config_dir != ""

    - name: ğŸ”„ Recargar systemd
      command: systemctl daemon-reload

    - name: ğŸ”„ Reiniciar servicio traefik-docker
      systemd:
        name: traefik-docker
        state: restarted
        enabled: true